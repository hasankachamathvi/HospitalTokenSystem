<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book Appointment</title>
    <link rel="stylesheet" href="webstyle.css">
    <script src="linkedlist.js"></script>
    <style>
        .booking-card {
            background-color: #fff;
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 450px;
            margin: 2rem auto;
            text-align: center;
        }
        .booking-card input {
            width: 100%;
            padding: 0.7rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .booking-card button {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 6px;
            background-color: #007BFF;
            color: white;
            cursor: pointer;
        }
        .booking-card button:hover {
            background-color: #0056b3;
        }
        table {
            width: 90%;
            max-width: 800px;
            margin: 2rem auto;
            border-collapse: collapse;
            text-align: center;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        th, td {
            padding: 0.8rem;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #007BFF;
            color: white;
        }
        tr:last-child td {
            border-bottom: none;
        }
    </style>
</head>
<body>

<header class="hero">
    <nav>
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="services.html">Services</a>
        <a href="doctors.html">Doctors</a>
        <a href="booking.html">Book Appointment</a>
        <a href="login.html">Login</a>
    </nav>
    <h1>HealthyLife Hospital</h1>
    <p>Your trusted partner in quality healthcare</p>
</header>

<main class="main-content">
    <!-- Statistics Cards -->
    <div style="display:flex; justify-content:center; gap:2rem; margin:2rem auto; max-width:900px; flex-wrap:wrap;">
        <div style="background:#fff; padding:1.5rem 2rem; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:center; min-width:150px;">
            <h3 style="margin:0; color:#666; font-size:14px;">Total Patients</h3>
            <p id="totalPatients" style="font-size:2rem; margin:0.5rem 0; color:#007BFF; font-weight:bold;">0</p>
        </div>
        <div style="background:#fff; padding:1.5rem 2rem; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:center; min-width:150px;">
            <h3 style="margin:0; color:#666; font-size:14px;">Waiting</h3>
            <p id="waitingPatients" style="font-size:2rem; margin:0.5rem 0; color:#ffc107; font-weight:bold;">0</p>
        </div>
        <div style="background:#fff; padding:1.5rem 2rem; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:center; min-width:150px;">
            <h3 style="margin:0; color:#666; font-size:14px;">Served</h3>
            <p id="servedPatients" style="font-size:2rem; margin:0.5rem 0; color:#28a745; font-weight:bold;">0</p>
        </div>
    </div>

    <div class="booking-card">
        <h2 style="margin-top:0;">Book Appointment</h2>
        <p style="font-size:12px; color:#666; margin-bottom:1rem;">All bookings are added as Normal priority</p>
        <input type="text" id="patientName" placeholder="Full Name">
        <input type="email" id="patientEmail" placeholder="Email">
        <input type="tel" id="patientPhone" placeholder="Phone">
        <input type="datetime-local" id="appointmentDate">
        <button onclick="bookPatient()">Book Appointment</button>
    </div>

    <h2 style="text-align:center;">Current Queue</h2>
    <table>
        <thead>
        <tr>
            <th>Token</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Date</th>
            <th>Priority</th>
        </tr>
        </thead>
        <tbody id="queueList"></tbody>
    </table>
</main>

<footer>
    <p>Â© 2026 HealthyLife Hospital. All rights reserved.</p>
</footer>

<script>
    // Initialize LinkedList for queue management
    const patientQueue = new LinkedList();
    
    function bookPatient() {
        const patient = {
            name: document.getElementById("patientName").value,
            email: document.getElementById("patientEmail").value,
            phone: document.getElementById("patientPhone").value,
            date: document.getElementById("appointmentDate").value
        };

        if (!patient.name || !patient.email || !patient.phone || !patient.date) {
            return alert("Please fill all fields");
        }

        // Send data to server
        const formData = new FormData();
        formData.append('name', patient.name);
        formData.append('email', patient.email);
        formData.append('phone', patient.phone);
        formData.append('date', patient.date);

        fetch('add_patient.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                // Add to LinkedList using insertAtEnd (normal priority patients go to end)
                console.log('Using LinkedList: Adding patient to end of queue (insertAtEnd operation)');
                patientQueue.insertAtEnd(patient);
                console.log('Current LinkedList queue:', patientQueue.traverse());
                
                alert('Appointment booked successfully!');
                // Clear form
                document.getElementById("patientName").value = "";
                document.getElementById("patientEmail").value = "";
                document.getElementById("patientPhone").value = "";
                document.getElementById("appointmentDate").value = "";
                // Refresh queue
                displayQueue();
            } else {
                alert('Error: ' + (data.message || 'Failed to book appointment'));
            }
        })
        .catch(error => {
            alert('Error booking appointment');
            console.error(error);
        });
    }

    function displayQueue() {
        fetch('get_queue.php')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(patients => {
            console.log('Fetched patients:', patients);
            
            // Rebuild LinkedList from database
            patientQueue.head = null; // Reset LinkedList
            patients.forEach(p => {
                patientQueue.insertAtEnd(p); // Populate LinkedList
            });
            
            // Get patients from LinkedList using traverse method
            const queuePatients = patientQueue.traverse();
            console.log('LinkedList Queue (traverse):', queuePatients);
            
            const table = document.getElementById("queueList");
            table.innerHTML = "";
            
            if (!queuePatients || queuePatients.length === 0) {
                const row = table.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 6;
                cell.innerText = "No appointments in queue";
                cell.style.textAlign = "center";
                
                // Update stats to 0
                document.getElementById('totalPatients').innerText = '0';
                document.getElementById('waitingPatients').innerText = '0';
                return;
            }
            
            let waitingCount = 0;
            
            queuePatients.forEach((p, index) => {
                // Priority badge color
                let priorityColor = '#28a745'; // green for normal
                if(p.priority === 'vip') priorityColor = '#ffc107'; // yellow
                if(p.priority === 'emergency') priorityColor = '#dc3545'; // red
                
                const row = table.insertRow();
                row.insertCell(0).innerText = p.queue_position || (index + 1);
                row.insertCell(1).innerText = p.name || 'N/A';
                row.insertCell(2).innerText = p.email || 'N/A';
                row.insertCell(3).innerText = p.phone || 'N/A';
                row.insertCell(4).innerText = p.date || 'N/A';
                
                const priorityCell = row.insertCell(5);
                priorityCell.innerHTML = `<span style="background:${priorityColor};color:white;padding:3px 8px;border-radius:3px;font-size:12px;">${p.priority?.toUpperCase() || 'NORMAL'}</span>`;
                
                if(p.status === 'waiting') waitingCount++;
            });
            
            // Update statistics
            document.getElementById('totalPatients').innerText = patients.length;
            document.getElementById('waitingPatients').innerText = waitingCount;
            
            // Fetch served count
            fetch('get_served_count.php')
            .then(response => response.json())
            .then(data => {
                document.getElementById('servedPatients').innerText = data.count || 0;
            })
            .catch(error => console.error('Error fetching served count:', error));
        })
        .catch(error => {
            console.error('Error fetching queue:', error);
            const table = document.getElementById("queueList");
            table.innerHTML = "";
            const row = table.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 6;
            cell.innerText = "Error loading appointments. Please check console.";
            cell.style.textAlign = "center";
            cell.style.color = "red";
        });
    }

    // Load queue on page load
    displayQueue();

    // Optional: live update every 2 seconds
    setInterval(() => displayQueue(), 2000);
</script>

</body>
</html>
